<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      color: #222;
    }
    .container {
      max-width: 1040px;
      margin: 40px auto;
      padding: 0 16px;
    }
    h1 {
      text-align: center;
      color: #2563eb;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 32px;
      letter-spacing: 2px;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 16px rgba(60,98,206,.08);
      padding: 2rem;
      margin-bottom: 32px;
      transition: box-shadow .2s;
    }
    .card:hover {
      box-shadow: 0 4px 32px rgba(60,98,206,.14);
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
      align-items: center;
    }
    .form-group {
      flex: 1 1 170px;
      min-width: 150px;
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-size: .98rem;
      font-weight: 500;
      margin-bottom: 4px;
      color: #555;
    }
    .form-group input,
    .form-group select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d3d8e8;
      background: #f8fafc;
      font-size: 1rem;
    }
    #addForm button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1.1rem;
      padding: 10px 24px;
      box-shadow: 0 2px 8px rgba(37,99,235,.10);
      cursor: pointer;
      margin-top: 12px;
      transition: background .18s;
    }
    #addForm button:hover {
      background: #1743a2;
    }
    #status {
      text-align: center;
      font-weight: 600;
      margin-bottom: 16px;
      font-size: 1rem;
    }
    .success {
      color: #059669;
    }
    .error {
      color: #dc2626;
    }
    .budget-section-group {
      margin-bottom: 36px;
      border-radius: 11px;
      box-shadow: 0 2px 12px rgba(60,98,206,.07);
      background: #f7fbff;
      padding-bottom: 8px;
      overflow: hidden;
    }
    .section-header-row {
      background: linear-gradient(90deg, #dbeafe 70%, #f1f5f9 100%);
      color: #2563eb;
      font-weight: bold;
      font-size: 1.17rem;
      letter-spacing: 1.5px;
      border-bottom: 2px solid #2563eb;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: none;
      margin-bottom: 0;
    }
    th, td {
      padding: 11px 9px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      font-size: 1rem;
    }
    th {
      background: #e3e8f0;
      color: #2563eb;
      font-weight: 600;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) td {
      background: #f4f7fa;
    }
    tr:hover td {
      background: #e9edfa;
    }
    td[contenteditable="true"]:focus {
      outline: 2px solid #2563eb;
      background: #f0f6ff;
    }
    .delete-btn {
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: .92rem;
      padding: 6px 14px;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(220,38,38,.08);
      transition: background .18s;
    }
    .delete-btn:hover {
      background: #a21a1a;
    }
    .calculator-section {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
    }
    .calculator-section label {
      font-weight: 500;
      color: #2563eb;
    }
    .calculator-section input {
      margin-left: 8px;
      margin-right: 22px;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #d3d8e8;
      background: #f8fafc;
      font-size: 1rem;
      width: 120px;
    }
    .calculator-section button {
      background: #059669;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 1rem;
      padding: 8px 18px;
      cursor: pointer;
      margin-right: 5px;
      transition: background .18s;
    }
    .calculator-section button:hover {
      background: #026249;
    }
    .calculator-modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999;
    }
    .calculator-content {
      background: #fff; padding: 2.2em 2em; border-radius: 12px; max-width: 600px; width: 96%; box-shadow: 0 6px 32px rgba(60,98,206,.18);
      position: relative;
      font-size: 1.09rem;
    }
    .close-modal {
      position: absolute; top: 18px; right: 18px;
      cursor: pointer; color: #888; font-size: 22px;
      font-weight: bold;
    }
    details summary {
      cursor: pointer;
      font-size: 1.08em;
      color: #2563eb;
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .schedule-table-container {
      overflow-x: auto;
      margin-top: 12px;
      border-radius: 8px;
      background: #f7fafc;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 4px rgba(60,98,206,.05);
      padding: 10px;
    }
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .96rem;
      background: #fff;
    }
    .schedule-table th {
      background: #f3f4f8;
      color: #222;
      font-weight: 600;
      border-bottom: 1px solid #e5e7eb;
      padding: 7px 5px;
      text-align: left;
    }
    .schedule-table td {
      padding: 6px 5px;
      border-bottom: 1px solid #e5e7eb;
    }
    .schedule-table tr:nth-child(even) td {
      background: #f7fbff;
    }
    @media (max-width: 700px) {
      .container {
        margin: 12px auto;
        padding: 0 4px;
      }
      .card {
        padding: 1em;
      }
      .form-row, .calculator-section {
        flex-direction: column;
        gap: 10px;
      }
      table th, table td {
        padding: 7px 4px;
        font-size: .95rem;
      }
      .calculator-content {
        padding: 1.2em .5em;
      }
      .schedule-table th, .schedule-table td {
        font-size: .92rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Budget Dashboard</h1>
    <div id="status"></div>
    <div class="card">
      <form id="addForm">
        <div class="form-row">
          <div class="form-group">
            <label for="section">Section</label>
            <select name="Section" id="section">
              <option>Income</option>
              <option>Housing</option>
              <option>Insurance</option>
              <option>Food</option>
              <option>Transportation</option>
              <option>Lifestyle</option>
              <option>Debt</option>
              <option>Savings</option>
            </select>
          </div>
          <div class="form-group">
            <label for="name">Name</label>
            <input name="Name" id="name" required>
          </div>
          <div class="form-group">
            <label for="origBal">Original Balance</label>
            <input name="Original Balance" id="origBal" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="remBal">Remaining Balance</label>
            <input name="Remaining Balance" id="remBal" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="rate">Interest Rate</label>
            <input name="Interest Rate" id="rate" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="plannedAmt">Planned Amount</label>
            <input name="Planned Amount" id="plannedAmt" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="receivedAmt">Received Amount</label>
            <input name="Received Amount" id="receivedAmt" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="monthlyPay">Monthly Payment</label>
            <input name="Monthly Payment" id="monthlyPay" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="paidSoFar">Paid So Far</label>
            <input name="Paid So Far" id="paidSoFar" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label for="dueDate">Due Date</label>
            <input name="Due Date" id="dueDate" type="text">
          </div>
        </div>
        <button type="submit">Add Row</button>
      </form>
    </div>
    <div class="card calculator-section">
      <label for="extraPaymentInput">Debt Payoff Calculators</label>
      <input id="extraPaymentInput" type="number" value="0" step="0.01" placeholder="Extra payment">
      <button type="button" onclick="showCalculator('snowball')">Snowball Payoff</button>
      <button type="button" onclick="showCalculator('avalanche')">Avalanche Payoff</button>
    </div>
    <div id="budgetSections"></div>
  </div>
  <!-- Calculator Modal -->
  <div id="calculatorModal" class="calculator-modal">
    <div class="calculator-content">
      <span class="close-modal" onclick="closeCalculatorModal()">&times;</span>
      <h2 id="calculatorTitle"></h2>
      <div id="calculatorResults"></div>
    </div>
  </div>
  <script>
    // Replace with your actual Apps Script URL
    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxtidN3tn0DDJ74iQUq7hV3foWFVt2U1-yZa4HtVHJ039RUNlJPAyPB9f-ooxtlGa8o/exec";
    const statusDiv = document.getElementById('status');
    const addForm = document.getElementById('addForm');
    const calculatorModal = document.getElementById('calculatorModal');
    const calculatorTitle = document.getElementById('calculatorTitle');
    const calculatorResults = document.getElementById('calculatorResults');
    const extraPaymentInput = document.getElementById('extraPaymentInput');
    const budgetSectionsDiv = document.getElementById('budgetSections');
    let sheetData = [];
    let headers = [];

    function setStatus(msg, type = '') {
      statusDiv.textContent = msg;
      statusDiv.className = type;
    }

    // Fetch and render data from Google Sheets
    function fetchSheetData() {
      setStatus('Loading data...');
      fetch(SHEETS_URL)
        .then(resp => resp.json())
        .then(data => {
          sheetData = data;
          headers = data[0];
          renderBudgetSections(data);
          setStatus('');
        })
        .catch(e => {
          setStatus('Error loading data!', 'error');
        });
    }

    // Render budget sections grouped and separated
    function renderBudgetSections(data) {
      if (!data || data.length < 2) {
        budgetSectionsDiv.innerHTML = '<div class="card">No data available.</div>';
        return;
      }
      // Group rows by Section
      const sectionOrder = [
        "Income", "Housing", "Insurance", "Food",
        "Transportation", "Lifestyle", "Debt", "Savings"
      ];
      const groups = {};
      for (const section of sectionOrder) groups[section] = [];
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        if(groups.hasOwnProperty(row[0])) {
          groups[row[0]].push({row, index: i});
        }
      }
      // Build HTML for sections
      let html = '';
      for (const section of sectionOrder) {
        if (groups[section].length === 0) continue;
        html += `<div class="budget-section-group">
          <table>
            <tr class="section-header-row">
              <td colspan="${headers.length+1}">${section}</td>
            </tr>
            <tr>` +
              headers.map(h => `<th>${h}</th>`).join('') +
              `<th>Delete</th></tr>`;
        for (const {row, index} of groups[section]) {
          html += '<tr>';
          for (let j = 0; j < row.length; j++) {
            // First column not editable (Section)
            if (j === 0) {
              html += `<td>${row[j]}</td>`;
            } else {
              html += `<td contenteditable="true" data-row="${index}" data-col="${j}" title="Click to edit">${row[j]}</td>`;
            }
          }
          html += `<td><button class="delete-btn" onclick="deleteRow(${index})">Delete</button></td></tr>`;
        }
        html += '</table></div>';
      }
      budgetSectionsDiv.innerHTML = html;
      // Add event listeners for inline editing
      Array.from(budgetSectionsDiv.querySelectorAll('td[contenteditable="true"]')).forEach(cell => {
        cell.addEventListener('blur', function() {
          let row = parseInt(cell.getAttribute('data-row'));
          let col = parseInt(cell.getAttribute('data-col'));
          let newValue = cell.textContent;
          updateCell(row, col, newValue);
        });
      });
    }

    // Add a new row
    addForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(addForm);
      const row = [
        formData.get('Section') || '',
        formData.get('Name') || '',
        formData.get('Original Balance') || '',
        formData.get('Remaining Balance') || '',
        formData.get('Interest Rate') || '',
        formData.get('Planned Amount') || '',
        formData.get('Received Amount') || '',
        formData.get('Monthly Payment') || '',
        formData.get('Paid So Far') || '',
        formData.get('Due Date') || ''
      ];
      setStatus('Adding row...');
      fetch(SHEETS_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({row})
      })
      .then(resp => resp.json())
      .then(result => {
        if (result.result === "success") {
          setStatus('Row added!', 'success');
          fetchSheetData();
          addForm.reset();
        } else {
          setStatus('Error adding row!', 'error');
        }
      })
      .catch(e => {
        setStatus('Error adding row!', 'error');
      });
    });

    // Delete a row
    function deleteRow(rowIndex) {
      if (!confirm('Delete this row?')) return;
      setStatus('Deleting row...');
      fetch(SHEETS_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({delete: rowIndex})
      })
      .then(resp => resp.json())
      .then(result => {
        if (result.result === "success") {
          setStatus('Row deleted!', 'success');
          fetchSheetData();
        } else {
          setStatus('Error deleting row!', 'error');
        }
      })
      .catch(e => {
        setStatus('Error deleting row!', 'error');
      });
    }
    window.deleteRow = deleteRow;

    // Update a cell
    function updateCell(rowIndex, colIndex, newValue) {
      setStatus('Updating cell...');
      fetch(SHEETS_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({update: { row: rowIndex, col: colIndex, value: newValue }})
      })
      .then(resp => resp.json())
      .then(result => {
        if (result.result === "success") {
          setStatus('Cell updated!', 'success');
          fetchSheetData();
        } else {
          setStatus('Error updating cell!', 'error');
        }
      })
      .catch(e => {
        setStatus('Error updating cell!', 'error');
      });
    }

    // Debt payoff calculators
    function showCalculator(type) {
      let debts = [];
      for (let i = 1; i < sheetData.length; i++) {
        if (sheetData[i][0] === "Debt") {
          debts.push({
            name: sheetData[i][1],
            balance: parseFloat(sheetData[i][3]) || 0,
            rate: parseFloat(sheetData[i][4]) || 0,
            payment: parseFloat(sheetData[i][7]) || 0,
          });
        }
      }
      let extra = parseFloat(extraPaymentInput.value) || 0;
      let result;
      if (type === 'snowball') {
        result = calculateSnowball(debts, extra);
        calculatorTitle.textContent = "Snowball Payoff Results";
      } else {
        result = calculateAvalanche(debts, extra);
        calculatorTitle.textContent = "Avalanche Payoff Results";
      }
      calculatorResults.innerHTML = result;
      calculatorModal.style.display = 'flex';
    }

    function closeCalculatorModal() {
      calculatorModal.style.display = 'none';
    }
    window.closeCalculatorModal = closeCalculatorModal;

    function calculateSnowball(debts, extra) {
      debts = debts.slice().sort((a,b) => a.balance - b.balance);
      return calculateDebtPayoff(debts, extra, "Snowball");
    }
    function calculateAvalanche(debts, extra) {
      debts = debts.slice().sort((a,b) => b.rate - a.rate);
      return calculateDebtPayoff(debts, extra, "Avalanche");
    }

    // Improved debt payoff logic with a neat schedule table
    function calculateDebtPayoff(debts, extra, method) {
      let months = 0, schedule = [];
      let totalPaid = 0;
      let debtsCopy = debts.map(d => ({...d}));
      let done = false;
      let start = new Date();
      let debtNames = debtsCopy.map(d => d.name);
      while (!done && months < 600) { // Prevent infinite loop
        months++;
        let paymentPool = extra;
        let balances = [];
        for (let i = 0; i < debtsCopy.length; i++) {
          let d = debtsCopy[i];
          if (d.balance <= 0) {
            balances.push(0);
            continue;
          }
          let interest = d.balance * (d.rate/100/12);
          let payAmt = Math.min(d.payment + paymentPool, d.balance + interest);
          d.balance += interest;
          d.balance -= payAmt;
          totalPaid += payAmt;
          paymentPool = Math.max(0, paymentPool - (payAmt - d.payment));
          if (d.balance < 0.01) d.balance = 0;
          if (d.balance === 0 && paymentPool > 0 && i < debtsCopy.length-1) {
            debtsCopy[i+1].payment += d.payment;
          }
          balances.push(d.balance);
        }
        done = debtsCopy.every(d => d.balance <= 0);
        schedule.push(balances);
      }
      let payoffDate = new Date(start.setMonth(start.getMonth() + months));
      let html = `<b>Full payoff in ${months} months (${payoffDate.toLocaleDateString()})</b><br>`;
      html += `<b>Total Paid:</b> $${totalPaid.toFixed(2)}<br>`;
      // Render the monthly schedule as a table
      html += `<details><summary>Monthly Schedule (click to expand)</summary>`;
      html += `<div class="schedule-table-container"><table class="schedule-table">
        <thead>
          <tr>
            <th>Month</th>`;
      for(let name of debtNames) {
        html += `<th>${name}</th>`;
      }
      html += `</tr></thead><tbody>`;
      for(let m = 0; m < schedule.length; m++) {
        html += `<tr><td>${m+1}</td>`;
        for(let b of schedule[m]) {
          html += `<td>$${b.toFixed(2)}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table></div></details>`;
      return html;
    }

    // Initial table load
    fetchSheetData();
  </script>
</body>
</html>
